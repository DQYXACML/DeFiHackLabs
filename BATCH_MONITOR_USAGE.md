# æ‰¹é‡Monitorè¾“å‡ºç”Ÿæˆè„šæœ¬ä½¿ç”¨è¯´æ˜

## ğŸ“ æ¦‚è¿°

`batch_generate_monitor.py` æ˜¯ä¸€ä¸ªæ‰¹é‡å¤„ç†è„šæœ¬ï¼Œç”¨äºè‡ªåŠ¨éå† `extracted_contracts` ç›®å½•ä¸‹æ‰€æœ‰åŒ…å« `attack_state.json` çš„é¡¹ç›®ï¼Œä¸ºæ¯ä¸ªé¡¹ç›®ç”Ÿæˆ Monitor åˆ†æè¾“å‡ºã€‚

## ğŸ¯ ä¸»è¦åŠŸèƒ½

- âœ… **è‡ªåŠ¨æ‰«æ**: é€’å½’æ‰«ææ‰€æœ‰åŒ…å« `attack_state.json` çš„é¡¹ç›®
- âœ… **æ™ºèƒ½è·³è¿‡**: è‡ªåŠ¨æ£€æµ‹å·²ç”Ÿæˆçš„è¾“å‡ºæ–‡ä»¶ï¼Œé¿å…é‡å¤å¤„ç†
- âœ… **å¹¶è¡Œå¤„ç†**: æ”¯æŒå¤šè¿›ç¨‹å¹¶è¡Œï¼Œæ˜¾è‘—åŠ é€Ÿæ‰¹å¤„ç†ï¼ˆè‡ªåŠ¨å¤„ç†ç«¯å£å†²çªï¼‰
- âœ… **å®¹é”™æœºåˆ¶**: å•ä¸ªé¡¹ç›®å¤±è´¥ä¸å½±å“å…¶ä»–é¡¹ç›®ï¼Œæœ€åç”Ÿæˆå®Œæ•´æŠ¥å‘Š
- âœ… **çµæ´»è¿‡æ»¤**: æ”¯æŒæŒ‰æ—¶é—´èŒƒå›´è¿‡æ»¤ã€é™åˆ¶æ•°é‡ç­‰
- âœ… **é¢„è§ˆæ¨¡å¼**: æ”¯æŒ dry-run æ¨¡å¼ï¼Œå…ˆé¢„è§ˆåæ‰§è¡Œ

## ğŸ“‹ å‘½ä»¤è¡Œå‚æ•°

```bash
python src/test/batch_generate_monitor.py [é€‰é¡¹]

é€‰é¡¹:
  --filter TEXT        è¿‡æ»¤æ¨¡å¼ï¼ˆå¦‚ "2024-01" åªå¤„ç†è¯¥æœˆä»½çš„é¡¹ç›®ï¼‰
  --limit INTEGER      é™åˆ¶å¤„ç†çš„é¡¹ç›®æ•°é‡ï¼ˆå¦‚ --limit 10ï¼‰
  --force              å¼ºåˆ¶é‡æ–°ç”Ÿæˆï¼Œè¦†ç›–å·²å­˜åœ¨çš„è¾“å‡ºæ–‡ä»¶
  --workers INTEGER    å¹¶è¡Œworkeræ•°é‡ï¼ˆé»˜è®¤4ï¼ŒèŒƒå›´1-8ï¼‰
  --rpc-url TEXT       ä¸»ç½‘RPC URLï¼ˆç”¨äºAnvil forkï¼‰
  --dry-run            é¢„è§ˆæ¨¡å¼ï¼Œåªæ˜¾ç¤ºå°†è¦å¤„ç†çš„é¡¹ç›®åˆ—è¡¨
  --verbose            è¯¦ç»†æ—¥å¿—æ¨¡å¼
  --log-file TEXT      æ—¥å¿—è¾“å‡ºæ–‡ä»¶ï¼ˆé»˜è®¤: batch_monitor.logï¼‰
  --help               æ˜¾ç¤ºå¸®åŠ©ä¿¡æ¯
```

## ğŸš€ ä½¿ç”¨ç¤ºä¾‹

### 1. åŸºç¡€ä½¿ç”¨

```bash
# å¤„ç†æ‰€æœ‰é¡¹ç›®ï¼ˆä½¿ç”¨4ä¸ªå¹¶è¡Œworkerï¼‰
python src/test/batch_generate_monitor.py

# åªå¤„ç†2024-01æœˆä»½çš„é¡¹ç›®
python src/test/batch_generate_monitor.py --filter 2024-01

# å¤„ç†2024-03æœˆä»½çš„é¡¹ç›®
python src/test/batch_generate_monitor.py --filter 2024-03
```

### 2. æµ‹è¯•å’Œé¢„è§ˆ

```bash
# é¢„è§ˆæ¨¡å¼ï¼šæŸ¥çœ‹å°†è¦å¤„ç†å“ªäº›é¡¹ç›®ï¼ˆä¸å®é™…æ‰§è¡Œï¼‰
python src/test/batch_generate_monitor.py --dry-run

# åªå¤„ç†å‰5ä¸ªé¡¹ç›®ï¼ˆç”¨äºæµ‹è¯•ï¼‰
python src/test/batch_generate_monitor.py --limit 5

# é¢„è§ˆ2024-03çš„å‰3ä¸ªé¡¹ç›®
python src/test/batch_generate_monitor.py --filter 2024-03 --limit 3 --dry-run
```

### 3. å¼ºåˆ¶é‡æ–°ç”Ÿæˆ

```bash
# å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰æ–‡ä»¶ï¼ˆè¦†ç›–å·²å­˜åœ¨çš„ï¼‰
python src/test/batch_generate_monitor.py --force

# å¼ºåˆ¶é‡æ–°ç”Ÿæˆ2024-01çš„æ‰€æœ‰æ–‡ä»¶
python src/test/batch_generate_monitor.py --filter 2024-01 --force
```

### 4. å¹¶è¡Œå¤„ç†ä¼˜åŒ–

```bash
# ä½¿ç”¨8ä¸ªå¹¶è¡ŒworkeråŠ é€Ÿå¤„ç†
python src/test/batch_generate_monitor.py --workers 8

# å¤„ç†2024-03æœˆä»½ï¼Œä½¿ç”¨6ä¸ªå¹¶è¡Œworker
python src/test/batch_generate_monitor.py --filter 2024-03 --workers 6
```

### 5. é«˜çº§ç»„åˆ

```bash
# ç»„åˆä½¿ç”¨ï¼šå¤„ç†2024-03çš„å‰10ä¸ªé¡¹ç›®ï¼Œä½¿ç”¨6ä¸ªworkerï¼Œè¯¦ç»†æ—¥å¿—
python src/test/batch_generate_monitor.py \
  --filter 2024-03 \
  --limit 10 \
  --workers 6 \
  --verbose

# å¼ºåˆ¶é‡æ–°ç”Ÿæˆæ‰€æœ‰2024å¹´çš„é¡¹ç›®ï¼Œä½¿ç”¨8ä¸ªworker
python src/test/batch_generate_monitor.py \
  --filter 2024 \
  --force \
  --workers 8 \
  --log-file full_regenerate.log
```

## ğŸ“Š è¾“å‡ºç¤ºä¾‹

### ç»ˆç«¯è¾“å‡º

```
================================================================================
æ‰¹å¤„ç†Monitorè¾“å‡ºç”Ÿæˆ - å¼€å§‹æ‰§è¡Œ
================================================================================
æ‰«æè·¯å¾„: extracted_contracts
è¿‡æ»¤æ¡ä»¶: 2024-03
æ‰¾åˆ°é¡¹ç›®: 10ä¸ª
å°†è¦å¤„ç†: 10ä¸ª
å°†è¦è·³è¿‡: 0ä¸ª (è¾“å‡ºæ–‡ä»¶å·²å­˜åœ¨)
å¼€å§‹å¹¶è¡Œå¤„ç† (workers=4)...
Anvilç«¯å£åˆ†é…: [8545, 8546, 8547, 8548]
âœ“ [1/10] BBT_exp - æˆåŠŸ (45.2s)
âœ“ [2/10] CGT_exp - æˆåŠŸ (38.7s)
âœ— [3/10] Juice_exp - å¤±è´¥: Anvil startup timeout
âœ“ [4/10] MO_exp - æˆåŠŸ (52.1s)
...
å¹¶è¡Œå¤„ç†å®Œæˆï¼Œæ€»è€—æ—¶: 156.3ç§’

================================================================================
æ‰¹å¤„ç†æ‰§è¡ŒæŠ¥å‘Š
================================================================================

ç»“æœæ±‡æ€»:
  âœ“ æˆåŠŸ: 8é¡¹
  âœ— å¤±è´¥: 2é¡¹
  âŠ˜ è·³è¿‡: 0é¡¹ (å·²å­˜åœ¨)
  æ€»è®¡: 10é¡¹

æˆåŠŸé¡¹ç›® (8ä¸ª):
  âœ“ BBT_exp
  âœ“ CGT_exp
  âœ“ MO_exp
  ...

å¤±è´¥é¡¹ç›® (2ä¸ª):
  âœ— Juice_exp
     é”™è¯¯: Anvil startup timeout
  âœ— LavaLending_exp
     é”™è¯¯: Test execution failed

è¯¦ç»†æ—¥å¿—å·²ä¿å­˜åˆ°: batch_monitor.log
================================================================================
```

## ğŸ“ ç”Ÿæˆçš„æ–‡ä»¶

### å¯¹äºæ¯ä¸ªé¡¹ç›®

æ¯ä¸ªæˆåŠŸå¤„ç†çš„é¡¹ç›®ä¼šç”Ÿæˆï¼š

```
autopath/{é¡¹ç›®å}_analysis.json
```

**ç¤ºä¾‹**:
- `autopath/BarleyFinance_exp_analysis.json`
- `autopath/CitadelFinance_exp_analysis.json`
- `autopath/Juice_exp_analysis.json`

### æ‰¹å¤„ç†æ—¥å¿—

- `batch_monitor.log` - è¯¦ç»†çš„æ‰§è¡Œæ—¥å¿—ï¼ˆé»˜è®¤ï¼‰
- æˆ–è‡ªå®šä¹‰çš„æ—¥å¿—æ–‡ä»¶ï¼ˆé€šè¿‡ `--log-file` æŒ‡å®šï¼‰

## âš™ï¸ å·¥ä½œåŸç†

### å¹¶è¡Œå¤„ç†æ¶æ„

è„šæœ¬ä½¿ç”¨ Python çš„ `multiprocessing.Pool` å®ç°å¹¶è¡Œå¤„ç†ï¼Œæ¯ä¸ª worker ä½¿ç”¨ç‹¬ç«‹çš„ Anvil ç«¯å£ï¼š

```
Worker 0: ç«¯å£ 8545
Worker 1: ç«¯å£ 8546
Worker 2: ç«¯å£ 8547
Worker 3: ç«¯å£ 8548
...
```

è¿™æ ·å¯ä»¥é¿å…å¹¶è¡Œæ‰§è¡Œæ—¶çš„ç«¯å£å†²çªé—®é¢˜ã€‚

### æ‰§è¡Œæµç¨‹

å¯¹äºæ¯ä¸ªé¡¹ç›®ï¼Œè„šæœ¬ä¼šï¼š

1. **æ£€æŸ¥è·³è¿‡æ¡ä»¶**: å¦‚æœè¾“å‡ºæ–‡ä»¶å·²å­˜åœ¨ä¸”é `--force` æ¨¡å¼ï¼Œè·³è¿‡
2. **è®¾ç½®ç«¯å£**: ä¸ºå½“å‰ worker åˆ†é…ç‹¬ç«‹çš„ Anvil ç«¯å£
3. **è°ƒç”¨å­è„šæœ¬**: æ‰§è¡Œ `generate_monitor_output.py --project <path>`
4. **æ”¶é›†ç»“æœ**: è®°å½•æˆåŠŸ/å¤±è´¥çŠ¶æ€
5. **ç”ŸæˆæŠ¥å‘Š**: æ±‡æ€»æ‰€æœ‰ç»“æœ

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### ç¯å¢ƒå˜é‡æ”¯æŒ

è„šæœ¬é€šè¿‡ç¯å¢ƒå˜é‡ `ANVIL_PORT` ä¼ é€’ç«¯å£å·ç»™ `generate_monitor_output.py`ï¼š

```python
env = os.environ.copy()
env["ANVIL_PORT"] = str(8545 + worker_id)
```

`generate_monitor_output.py` å·²ç»è¢«ä¿®æ”¹ä¸ºæ”¯æŒæ­¤ç¯å¢ƒå˜é‡ï¼š

```python
ANVIL_PORT = int(os.environ.get('ANVIL_PORT', '8545'))
```

### é”™è¯¯å¤„ç†

- **å®¹é”™æ¨¡å¼**: å•ä¸ªé¡¹ç›®å¤±è´¥ä¸ä¼šä¸­æ–­æ•´ä¸ªæ‰¹å¤„ç†
- **è¶…æ—¶ä¿æŠ¤**: æ¯ä¸ªé¡¹ç›®æœ‰10åˆ†é’Ÿçš„æ‰§è¡Œè¶…æ—¶é™åˆ¶
- **è¯¦ç»†æ—¥å¿—**: æ‰€æœ‰é”™è¯¯éƒ½ä¼šè®°å½•å †æ ˆè·Ÿè¸ªåˆ°æ—¥å¿—æ–‡ä»¶

## ğŸ“Œ æ³¨æ„äº‹é¡¹

### 1. ç³»ç»Ÿèµ„æº

å¹¶è¡Œå¤„ç†ä¼šå ç”¨è¾ƒå¤šç³»ç»Ÿèµ„æºï¼š
- æ¯ä¸ª worker ä¼šå¯åŠ¨ä¸€ä¸ª Anvil å®ä¾‹
- å»ºè®®æ ¹æ®æœºå™¨æ€§èƒ½è°ƒæ•´ `--workers` å‚æ•°
- é»˜è®¤4ä¸ªworkeré€šå¸¸æ˜¯å®‰å…¨çš„é€‰æ‹©

### 2. ç½‘ç»œè¦æ±‚

- éœ€è¦ç¨³å®šçš„ä¸»ç½‘ RPC è¿æ¥ï¼ˆç”¨äº Anvil forkï¼‰
- å¦‚æœä½¿ç”¨å…¬å…± RPC å¯èƒ½é‡åˆ°é€Ÿç‡é™åˆ¶
- å¯ä»¥é€šè¿‡ `--rpc-url` æŒ‡å®šè‡ªå·±çš„ RPC èŠ‚ç‚¹

### 3. ç£ç›˜ç©ºé—´

æ¯ä¸ª `*_analysis.json` æ–‡ä»¶å¤§å°ä¸ä¸€ï¼š
- å°å‹æ”»å‡»: å‡  KB
- å¤§å‹æ”»å‡»: å¯èƒ½è¶…è¿‡ 200 KB
- å¤„ç†æ‰€æœ‰54ä¸ªé¡¹ç›®å¤§çº¦éœ€è¦ 10-50 MB

### 4. æ‰§è¡Œæ—¶é—´

å¤„ç†æ—¶é—´å› é¡¹ç›®è€Œå¼‚ï¼š
- ç®€å•é¡¹ç›®: 30-60ç§’
- å¤æ‚é¡¹ç›®: 2-5åˆ†é’Ÿ
- å¤±è´¥/è¶…æ—¶é¡¹ç›®: æœ€å¤š10åˆ†é’Ÿ

**ä¼°ç®—**:
- å¤„ç†10ä¸ªé¡¹ç›®ï¼ˆ4 workersï¼‰: çº¦5-10åˆ†é’Ÿ
- å¤„ç†æ‰€æœ‰54ä¸ªé¡¹ç›®ï¼ˆ4 workersï¼‰: çº¦30-60åˆ†é’Ÿ

## ğŸ› æ•…éšœæ’æŸ¥

### é—®é¢˜1: "æœªæ‰¾åˆ°ä»»ä½•ç¬¦åˆæ¡ä»¶çš„é¡¹ç›®"

**åŸå› **:
- `extracted_contracts` ç›®å½•ä¸å­˜åœ¨
- è¯¥ç›®å½•ä¸‹æ²¡æœ‰åŒ…å« `attack_state.json` çš„é¡¹ç›®

**è§£å†³**:
```bash
# æ£€æŸ¥ç›®å½•æ˜¯å¦å­˜åœ¨
ls -la extracted_contracts/

# æŸ¥æ‰¾æ‰€æœ‰ attack_state.json
find extracted_contracts -name "attack_state.json"
```

### é—®é¢˜2: æ‰€æœ‰é¡¹ç›®éƒ½è¢«è·³è¿‡

**åŸå› **: è¾“å‡ºæ–‡ä»¶å·²ç»å­˜åœ¨

**è§£å†³**: ä½¿ç”¨ `--force` å¼ºåˆ¶é‡æ–°ç”Ÿæˆ
```bash
python src/test/batch_generate_monitor.py --force
```

### é—®é¢˜3: "Anvil startup timeout"

**åŸå› **:
- RPC è¿æ¥é—®é¢˜
- ç½‘ç»œä¸ç¨³å®š
- ç«¯å£è¢«å ç”¨

**è§£å†³**:
```bash
# æ£€æŸ¥ç«¯å£æ˜¯å¦è¢«å ç”¨
netstat -tunlp | grep 854[5-8]

# å‡å°‘å¹¶è¡Œworkeræ•°é‡
python src/test/batch_generate_monitor.py --workers 2

# ä½¿ç”¨ä¸åŒçš„ RPC
python src/test/batch_generate_monitor.py --rpc-url https://your-rpc-url
```

### é—®é¢˜4: è¿›ç¨‹å¡ä½ä¸åŠ¨

**åŸå› **: æŸä¸ªé¡¹ç›®æ‰§è¡Œæ—¶é—´è¿‡é•¿

**è§£å†³**:
- ç­‰å¾…è¶…æ—¶ï¼ˆ10åˆ†é’Ÿåä¼šè‡ªåŠ¨è·³è¿‡ï¼‰
- æˆ–æŒ‰ `Ctrl+C` ä¸­æ–­æ‰§è¡Œ
- ä½¿ç”¨ `--limit` é™åˆ¶æ•°é‡è¿›è¡Œåˆ†æ‰¹å¤„ç†

## ğŸ“š ç›¸å…³æ–‡æ¡£

- `src/test/generate_monitor_output.py` - åº•å±‚çš„å•é¡¹ç›®å¤„ç†è„šæœ¬
- `MONITOR_OUTPUT_GENERATION.md` - Monitorè¾“å‡ºç”Ÿæˆè¯¦ç»†è¯´æ˜
- `autopath/` - Go Monitor å·¥å…·ç›®å½•

## ğŸ’¡ æœ€ä½³å®è·µ

### é¦–æ¬¡ä½¿ç”¨

1. å…ˆç”¨é¢„è§ˆæ¨¡å¼äº†è§£å°†è¦å¤„ç†ä»€ä¹ˆï¼š
```bash
python src/test/batch_generate_monitor.py --dry-run
```

2. ç”¨å°æ‰¹é‡æµ‹è¯•ï¼š
```bash
python src/test/batch_generate_monitor.py --limit 3
```

3. ç¡®è®¤æ— è¯¯åå¤„ç†å…¨éƒ¨ï¼š
```bash
python src/test/batch_generate_monitor.py
```

### å¤§è§„æ¨¡å¤„ç†

1. æŒ‰æœˆä»½åˆ†æ‰¹å¤„ç†ï¼š
```bash
for month in 2024-01 2024-02 2024-03; do
  python src/test/batch_generate_monitor.py --filter $month
done
```

2. ä½¿ç”¨æ›´å¤š worker åŠ é€Ÿï¼š
```bash
python src/test/batch_generate_monitor.py --workers 8
```

3. ä¿å­˜è¯¦ç»†æ—¥å¿—ä¾¿äºè°ƒè¯•ï¼š
```bash
python src/test/batch_generate_monitor.py \
  --verbose \
  --log-file detailed_$(date +%Y%m%d).log
```

## ğŸ‰ å¿«é€Ÿå¼€å§‹

æœ€ç®€å•çš„ç”¨æ³•ï¼Œå¤„ç†æ‰€æœ‰è¿˜æœªç”Ÿæˆè¾“å‡ºçš„é¡¹ç›®ï¼š

```bash
python src/test/batch_generate_monitor.py
```

å°±è¿™ä¹ˆç®€å•ï¼è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
- æ‰«ææ‰€æœ‰é¡¹ç›®
- è·³è¿‡å·²å¤„ç†çš„
- å¹¶è¡Œå¤„ç†å‰©ä½™çš„
- ç”Ÿæˆå®Œæ•´æŠ¥å‘Š

---

**ä½œè€…**: Claude Code
**ç‰ˆæœ¬**: 1.0.0
**æœ€åæ›´æ–°**: 2025-11-03
